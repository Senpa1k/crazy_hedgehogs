#!/bin/bash

LOG_DIR="$HOME/lab/log"
BACKUP_DIR="$HOME/lab/backup"
SCRIPT="$HOME/lab/script.sh" 


clean_log() {
    rm -f "$LOG_DIR"/*
}

show_log() {
    echo "Содержимое папки log:"
    ls -lh "$LOG_DIR"
    du -sh "$LOG_DIR"
    echo "------"
}

clean_log
echo "=== TEST 1: пустая папка ==="
bash "$SCRIPT" "$LOG_DIR" 90
show_log

clean_log
echo "=== TEST 2: несколько маленьких файлов ==="
dd if=/dev/zero of="$LOG_DIR/file1.txt" bs=1M count=10
dd if=/dev/zero of="$LOG_DIR/file2.txt" bs=20M count=1
dd if=/dev/zero of="$LOG_DIR/file3.txt" bs=5M count=1
bash "$SCRIPT" "$LOG_DIR" 80
show_log

clean_log
echo "=== TEST 3: много файлов выше лимита ==="
for i in {1..10}; do
    dd if=/dev/zero of="$LOG_DIR/file_$i.txt" bs=50M count=1
done
bash "$SCRIPT" "$LOG_DIR" 50
show_log
echo "Содержимое папки backup:"
ls -lh "$BACKUP_DIR"

clean_log
echo "=== TEST 4: один большой файл ==="
dd if=/dev/zero of="$LOG_DIR/big_file.bin" bs=600M count=1
bash "$SCRIPT" "$LOG_DIR" 50
show_log
ls -lh "$BACKUP_DIR"

clean_log
echo "=== TEST 5: файлы с одинаковым timestamp ==="
for i in {1..3}; do
    dd if=/dev/zero of="$LOG_DIR/file_$i.txt" bs=50M count=1
done
touch -t 202001010000 "$LOG_DIR"/*
bash "$SCRIPT" "$LOG_DIR" 50
show_log
ls -lh "$BACKUP_DIR"

echo "=== TEST 6: несуществующая папка ==="
bash "$SCRIPT" "$HOME/lab/nonexistent" 50

clean_log
echo "=== TEST 7: много маленьких файлов, под лимитом ==="
for i in {1..20}; do
    dd if=/dev/zero of="$LOG_DIR/file_$i.txt" bs=10M count=1
done
bash "$SCRIPT" "$LOG_DIR" 70
show_log

clean_log
echo "=== TEST 8: маленький + большой файл ==="
dd if=/dev/zero of="$LOG_DIR/small.txt" bs=5M count=1
dd if=/dev/zero of="$LOG_DIR/huge.bin" bs=800M count=1
bash "$SCRIPT" "$LOG_DIR" 60
show_log
ls -lh "$BACKUP_DIR"

echo "=== Все тесты завершены ==="

LOG_DIR="$HOME/lab/log"
BACKUP_DIR="$HOME/lab/backup"
SCRIPT="$HOME/lab/cleanup.sh" 


clean_log() {
    rm -f "$LOG_DIR"/*
}

show_log() {
    echo "Содержимое папки log:"
    ls -lh "$LOG_DIR"
    du -sh "$LOG_DIR"
    echo "------"
}

clean_log
echo "=== TEST 1: пустая папка ==="
bash "$SCRIPT" "$LOG_DIR" 90
show_log

clean_log
echo "=== TEST 2: несколько маленьких файлов ==="
dd if=/dev/zero of="$LOG_DIR/file1.txt" bs=1M count=10
dd if=/dev/zero of="$LOG_DIR/file2.txt" bs=20M count=1
dd if=/dev/zero of="$LOG_DIR/file3.txt" bs=5M count=1
bash "$SCRIPT" "$LOG_DIR" 80
show_log

clean_log
echo "=== TEST 3: много файлов выше лимита ==="
for i in {1..10}; do
    dd if=/dev/zero of="$LOG_DIR/file_$i.txt" bs=50M count=1
done
bash "$SCRIPT" "$LOG_DIR" 50
show_log
echo "Содержимое папки backup:"
ls -lh "$BACKUP_DIR"

clean_log
echo "=== TEST 4: один большой файл ==="
dd if=/dev/zero of="$LOG_DIR/big_file.bin" bs=600M count=1
bash "$SCRIPT" "$LOG_DIR" 50
show_log
ls -lh "$BACKUP_DIR"

clean_log
echo "=== TEST 5: файлы с одинаковым timestamp ==="
for i in {1..3}; do
    dd if=/dev/zero of="$LOG_DIR/file_$i.txt" bs=50M count=1
done
touch -t 202001010000 "$LOG_DIR"/*
bash "$SCRIPT" "$LOG_DIR" 50
show_log
ls -lh "$BACKUP_DIR"

echo "=== TEST 6: несуществующая папка ==="
bash "$SCRIPT" "$HOME/lab/nonexistent" 50

clean_log
echo "=== TEST 7: много маленьких файлов, под лимитом ==="
for i in {1..20}; do
    dd if=/dev/zero of="$LOG_DIR/file_$i.txt" bs=10M count=1
done
bash "$SCRIPT" "$LOG_DIR" 70
show_log

clean_log
echo "=== TEST 8: маленький + большой файл ==="
dd if=/dev/zero of="$LOG_DIR/small.txt" bs=5M count=1
dd if=/dev/zero of="$LOG_DIR/huge.bin" bs=800M count=1
bash "$SCRIPT" "$LOG_DIR" 60
show_log
ls -lh "$BACKUP_DIR"

echo "=== Все тесты завершены ==="

